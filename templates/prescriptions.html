{% extends "base.html" %}
{% block content %}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="color: #2c3e50; font-weight: 600;">
            <i class="fas fa-prescription-bottle-alt me-2" style="color: #9b59b6;"></i>Prescription Management
        </h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrescriptionModal">
            <i class="fas fa-plus me-1"></i>Add New Prescription
        </button>
    </div>

    <!-- Search and Filter Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header py-3" style="background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white;">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i>Search Prescriptions</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('prescriptions') }}" class="row g-3">
                <div class="col-md-8">
                    <input type="text" name="search" class="form-control" placeholder="Search by patient name, doctor name, or medication..." value="{{ search_query }}">
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i>Search
                    </button>
                </div>
            </form>
            {% if search_query %}
            <div class="mt-3">
                <small class="text-muted">Showing results for: "{{ search_query }}"</small>
                <a href="{{ url_for('prescriptions') }}" class="btn btn-sm btn-outline-secondary ms-2">Clear</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Prescriptions List -->
    <div class="card shadow-sm">
        <div class="card-header py-3" style="background: linear-gradient(135deg, #34495e, #2c3e50); color: white;">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>All Prescriptions</h5>
        </div>
        <div class="card-body">
            {% if prescriptions %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead style="background-color: #ecf0f1;">
                        <tr>
                            <th>Medication</th>
                            <th>Patient</th>
                            <th>Doctor</th>
                            <th>Dosage</th>
                            <th>Frequency</th>
                            <th>Duration</th>
                            <th>Date Prescribed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for prescription in prescriptions %}
                        <tr>
                            <td>
                                <strong>{{ prescription.medication_name }}</strong>
                                {% if prescription.instructions %}
                                <br><small class="text-muted">{{ prescription.instructions|truncate(30) }}</small>
                                {% endif %}
                            </td>
                            <td>{{ prescription.patient.first_name }} {{ prescription.patient.surname }}</td>
                            <td>Dr. {{ prescription.doctor.name }}</td>
                            <td><span class="badge bg-info">{{ prescription.dosage }}</span></td>
                            <td><span class="badge bg-warning text-dark">{{ prescription.frequency }}</span></td>
                            <td><span class="badge bg-secondary">{{ prescription.duration }}</span></td>
                            <td>{{ prescription.date_prescribed.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewPrescriptionModal{{ prescription.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#editPrescriptionModal{{ prescription.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <a href="{{ url_for('delete_prescription', prescription_id=prescription.id) }}" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete this prescription?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>

                        <!-- View Prescription Modal -->
                        <div class="modal fade" id="viewPrescriptionModal{{ prescription.id }}" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header" style="background: linear-gradient(135deg, #3498db, #2980b9); color: white;">
                                        <h5 class="modal-title">
                                            <i class="fas fa-prescription-bottle-alt me-2"></i>Prescription Details
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-primary mb-3">Medication Information</h6>
                                                <p><strong>Medication:</strong> {{ prescription.medication_name }}</p>
                                                <p><strong>Dosage:</strong> <span class="badge bg-info">{{ prescription.dosage }}</span></p>
                                                <p><strong>Frequency:</strong> <span class="badge bg-warning text-dark">{{ prescription.frequency }}</span></p>
                                                <p><strong>Duration:</strong> <span class="badge bg-secondary">{{ prescription.duration }}</span></p>
                                                {% if prescription.instructions %}
                                                <p><strong>Instructions:</strong> {{ prescription.instructions }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="text-primary mb-3">Patient & Doctor</h6>
                                                <p><strong>Patient:</strong> {{ prescription.patient.first_name }} {{ prescription.patient.surname }}</p>
                                                <p><strong>Age:</strong> {{ prescription.patient.age }} years</p>
                                                <p><strong>Gender:</strong> {{ prescription.patient.gender }}</p>
                                                <p><strong>Prescribing Doctor:</strong> Dr. {{ prescription.doctor.name }}</p>
                                                <p><strong>Specialization:</strong> {{ prescription.doctor.specialization }}</p>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <h6 class="text-primary mb-3">Prescription Details</h6>
                                                <p><strong>Date Prescribed:</strong> {{ prescription.date_prescribed.strftime('%B %d, %Y') }}</p>
                                                <p><strong>Prescription ID:</strong> #{{ prescription.id }}</p>
                                                <p><strong>Date Created:</strong> {{ prescription.date_created.strftime('%Y-%m-%d %H:%M') }}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Prescription Modal -->
                        <div class="modal fade" id="editPrescriptionModal{{ prescription.id }}" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header" style="background: linear-gradient(135deg, #f39c12, #e67e22); color: white;">
                                        <h5 class="modal-title">
                                            <i class="fas fa-edit me-2"></i>Edit Prescription
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form method="POST" action="{{ url_for('edit_prescription', prescription_id=prescription.id) }}">
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Medication Name *</label>
                                                    <input type="text" name="medication_name" class="form-control" value="{{ prescription.medication_name }}" required>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Dosage *</label>
                                                    <input type="text" name="dosage" class="form-control" value="{{ prescription.dosage }}" required>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Frequency *</label>
                                                    <select name="frequency" class="form-select" required>
                                                        <option value="Once daily" {% if prescription.frequency == 'Once daily' %}selected{% endif %}>Once daily</option>
                                                        <option value="Twice daily" {% if prescription.frequency == 'Twice daily' %}selected{% endif %}>Twice daily</option>
                                                        <option value="Three times daily" {% if prescription.frequency == 'Three times daily' %}selected{% endif %}>Three times daily</option>
                                                        <option value="Four times daily" {% if prescription.frequency == 'Four times daily' %}selected{% endif %}>Four times daily</option>
                                                        <option value="As needed" {% if prescription.frequency == 'As needed' %}selected{% endif %}>As needed</option>
                                                        <option value="Before meals" {% if prescription.frequency == 'Before meals' %}selected{% endif %}>Before meals</option>
                                                        <option value="After meals" {% if prescription.frequency == 'After meals' %}selected{% endif %}>After meals</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Duration *</label>
                                                    <select name="duration" class="form-select" required>
                                                        <option value="3 days" {% if prescription.duration == '3 days' %}selected{% endif %}>3 days</option>
                                                        <option value="5 days" {% if prescription.duration == '5 days' %}selected{% endif %}>5 days</option>
                                                        <option value="7 days" {% if prescription.duration == '7 days' %}selected{% endif %}>7 days</option>
                                                        <option value="10 days" {% if prescription.duration == '10 days' %}selected{% endif %}>10 days</option>
                                                        <option value="14 days" {% if prescription.duration == '14 days' %}selected{% endif %}>14 days</option>
                                                        <option value="30 days" {% if prescription.duration == '30 days' %}selected{% endif %}>30 days</option>
                                                        <option value="Ongoing" {% if prescription.duration == 'Ongoing' %}selected{% endif %}>Ongoing</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Patient *</label>
                                                    <select name="patient_id" class="form-select" required>
                                                        {% for p in patients %}
                                                        <option value="{{ p.id }}" {% if p.id == prescription.patient_id %}selected{% endif %}>{{ p.first_name }} {{ p.surname }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Doctor *</label>
                                                    <select name="doctor_id" class="form-select" required>
                                                        {% for d in doctors %}
                                                        <option value="{{ d.id }}" {% if d.id == prescription.doctor_id %}selected{% endif %}>Dr. {{ d.name }} - {{ d.specialization }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Instructions</label>
                                                <textarea name="instructions" class="form-control" rows="3" placeholder="Special instructions for taking the medication...">{{ prescription.instructions }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Date Prescribed *</label>
                                                <input type="date" name="date_prescribed" class="form-control" value="{{ today.strftime('%Y-%m-%d') }}" required>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-warning">Update Prescription</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if total_pages > 1 %}
            <nav aria-label="Prescription pagination">
                <ul class="pagination justify-content-center">
                    {% for p in range(1, total_pages + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('prescriptions', page=p, search=search_query) }}">{{ p }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-prescription-bottle fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Prescriptions Found</h5>
                <p class="text-muted">No prescriptions match your search criteria.</p>
                {% if search_query %}
                <a href="{{ url_for('prescriptions') }}" class="btn btn-primary">View All Prescriptions</a>
                {% else %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrescriptionModal">
                    <i class="fas fa-plus me-1"></i>Add Your First Prescription
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Prescription Modal -->
<!-- Add Prescription Modal -->
<div class="modal fade" id="addPrescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #27ae60, #219a52); color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Add New Prescription
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_prescription') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Medication Name *</label>
                            <input type="text" name="medication_name" class="form-control" placeholder="Enter medication name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Dosage *</label>
                            <input type="text" name="dosage" class="form-control" placeholder="e.g., 500mg, 10ml" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Frequency *</label>
                            <select name="frequency" class="form-select" required>
                                <option value="" disabled selected>Select frequency</option>
                                <option value="Once daily">Once daily</option>
                                <option value="Twice daily">Twice daily</option>
                                <option value="Three times daily">Three times daily</option>
                                <option value="Four times daily">Four times daily</option>
                                <option value="As needed">As needed</option>
                                <option value="Before meals">Before meals</option>
                                <option value="After meals">After meals</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Duration *</label>
                            <select name="duration" class="form-select" required>
                                <option value="" disabled selected>Select duration</option>
                                <option value="3 days">3 days</option>
                                <option value="5 days">5 days</option>
                                <option value="7 days">7 days</option>
                                <option value="10 days">10 days</option>
                                <option value="14 days">14 days</option>
                                <option value="30 days">30 days</option>
                                <option value="Ongoing">Ongoing</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Patient *</label>
                            <select name="patient_id" class="form-select" required id="patientSelect">
                                <option value="" disabled selected>Select patient</option>
                                {% for p in patients %}
                                <option value="{{ p.id }}">{{ p.first_name }} {{ p.surname }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Doctor *</label>
                            <select name="doctor_id" class="form-select" required>
                                <option value="" disabled selected>Select doctor</option>
                                {% for d in doctors %}
                                <option value="{{ d.id }}">Dr. {{ d.name }} - {{ d.specialization }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Instructions</label>
                        <textarea name="instructions" class="form-control" rows="3" placeholder="Special instructions for taking the medication..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Date Prescribed *</label>
                        <!-- FIXED LINE: Use 'today' variable passed from Flask -->
                        <input type="date" name="date_prescribed" class="form-control" value="{{ today.strftime('%Y-%m-%d') }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Prescription</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.prescription-card {
    border-left: 4px solid #9b59b6;
    transition: all 0.2s ease;
}

.prescription-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Patient selection handler for real-time info
    const patientSelect = document.getElementById('patientSelect');
    if (patientSelect) {
        patientSelect.addEventListener('change', function() {
            const patientId = this.value;
            if (patientId) {
                fetch(`/get_patient_info/${patientId}`)
                    .then(response => response.json())
                    .then(data => {
                        // You can display patient info if needed
                        console.log('Patient info:', data);
                    })
                    .catch(error => console.error('Error fetching patient info:', error));
            }
        });
    }
});
</script>

{% endblock %}